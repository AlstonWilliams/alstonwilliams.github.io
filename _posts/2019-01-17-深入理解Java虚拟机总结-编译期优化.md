---
layout: post
title: 深入理解Java虚拟机总结-编译期优化
date: 2019-02-17
author: AlstonWilliams
header-img: img/post-bg-2015.jpg
catalog: true
categories:
- JVM
tags:
- JVM
---
> 注:此文是我在读完**周志明**老师的**深入理解Java虚拟机**之后总结的一篇文章，请阅读此书获取更加详细的信息．

在这篇文章中，我们会简单介绍一下Java的编译过程，以及在编译过程中进行的优化．

## 编译过程

编译过程大致分为下面的三个过程，分别是:

- 解析与填充符号表过程
- 插入式注解处理器的注解处理过程
- 分析与字节码生成关系

它们之间的关系如下图所示：

![](http://upload-images.jianshu.io/upload_images/4108852-f4a9022b9659d089.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

#### 解析和填充符号表

**1.词法分析，语法分析：**

词法分析是将源代码中的字符流转变为Token集合．

语法分析是根据Token序列构造抽象语法树的过程，抽象语法树是一种用来描述程序代码语法结构的树型表示方式，语法树的每一个节点都代表着程序代码中的一个语法结构，例如包，类型，修饰符，运算符，接口，返回值甚至代码注释等都可以是一个语法结构．

**2.填充符号表：**

符号表是由一组符号地址和符号信息构成的表格，符号表中所登记的信息在编译的不同阶段都要用到．在语义分析中，符号表所登记的内容将用于语义检查(如检查一个名字的使用和原先的说明是否一致)和产生中间代码，在目标代码生成阶段，当对符号表进行地址分配时，符号表是地址分配的依据．

#### 注解处理器

注解处理器用于处理程序中的代码，由于注解会修改源代码，也就是会修改抽象语法树中的元素，所以如果在处理注解期间对语法树进行了修改，编译器将回到解析及填充符号表的过程重新处理，直到所有插入式注解处理器都没有再对语法树进行修改为止．

#### 语义分析与字节码生成

在编译过程中，语义分析过程分为标注检查以及数据及控制流分析两个步骤．

**1.标注检查：**

标注检查步骤检查的内容包括诸如变量使用前是否已被声明，变量和赋值之间的数据类型是否能够匹配等．

**2.数据及控制流分析：**

数据及控制流分析是对程序上下文逻辑更进一步的验证，它可以检查出诸如程序局部变量在使用前是否有赋值，方法的每条路径是否都有返回值，是否所有的受查异常都被正确处理了等问题．

**3.解语法糖：**

Java中最常用的语法糖主要是前面提到过的泛型，变长参数，自动装箱／拆箱等，虚拟机运行时并不支持这些语法糖，它们在编译阶段还原回简单的基础语法结构，这个过程称为解语法糖．

**4.字节码生成：**

字节码生成阶段不仅仅是把前面各个步骤生成的信息(语法树，符号表)转化成字节码写到磁盘中，编译器还进行了少量的代码添加和转换工作.

例如，之前的文章提到过的实例构造器**<init>()方法和类构造器<clinit>()方法**就是在这个阶段添加到语法树之中的．

完成对语法树的遍历和调整之后，就会把填充了所有所需信息的符号表交给com.sun.tools.javac.jvm.ClassWriter类，由这个类的writeClass()方法输出字节码，生成最终的Class文件，到此为止整个编译过程宣告结束．

## Java语法糖

#### 泛型与类型擦除

泛型可谓是Java中最常用的几个语法糖中的一个，但是Java中的泛型和C++中的语法糖不一样，它只存在于程序代码中，在经过编译之后的Class文件中，便不再存在．

那我们是如何获取到泛型传入的参数化类型呢？

这就涉及到Class文件中的**Signature，LocalVariableTypeTable**等属性了．其中**Signature**是最重要的一项属性，它的作用就是存储一个方法在字节码层面的特征签名，这个属性中保存的参数类型并不是原生类型，而是包括了参数化类型的信息．修改后的虚拟机规范要求所有能识别49.0以上版本的Class文件的虚拟机都要能正确地识别Signature参数．

#### 自动装箱，拆箱与遍历循环

自动装箱，拆箱在编译之后被转化成了对应的包装和还原方法，而遍历循环则把代码还原成了迭代器的实现，这也是为何遍历循环需要被遍历的类实现Iterable接口的原因．变长参数呢，在调用的时候变成了一个数组类型的参数．

#### 条件编译

Java中进行条件编译的方式是，使用条件为常量的if语句．在编译时，会把分支中不成立的代码块消除掉．

## 总结

可以看到，其实编译器并没有进行什么优化，而只是解语法糖，去掉不需要的代码而已．代码的优化实际上主要是在运行期完成，后面我们会写一篇文章专门来介绍编译器优化．
